<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バイオピリン検査 - エントリー・ログイン</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header text-center">
                <h1 class="logo mb-2">バイオピリン検査</h1>
                <p class="card-description">キット登録・ログイン</p>
            </div>

            <!-- アラート表示エリア -->
            <div id="alertArea"></div>

            <!-- キットID表示 -->
            <div id="kitIdDisplay" class="kit-id-display hidden">
                <div class="kit-id-label">キットID</div>
                <div class="kit-id-value" id="kitIdValue">-</div>
            </div>

            <!-- ログイン/新規登録タブ -->
            <div class="tab-buttons mb-4">
                <button class="btn btn-primary" id="loginTab" onclick="switchTab('login')">ログイン</button>
                <button class="btn btn-secondary" id="registerTab" onclick="switchTab('register')">新規登録</button>
            </div>

            <!-- ログインフォーム -->
            <form id="loginForm" class="hidden">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">
                        メールアドレス<span class="required">*</span>
                    </label>
                    <input
                        type="email"
                        id="loginEmail"
                        class="form-input"
                        placeholder="example@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="loginPassword">
                        パスワード<span class="required">*</span>
                    </label>
                    <input
                        type="password"
                        id="loginPassword"
                        class="form-input"
                        placeholder="パスワードを入力"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary btn-full">
                    ログイン
                </button>
            </form>

            <!-- 新規登録フォーム -->
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="kitId">
                        キットID<span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="kitId"
                        class="form-input"
                        placeholder="KIT-XXXX-XXXX"
                        required
                    >
                    <div class="form-help">QRコードから自動入力されます</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerEmail">
                        メールアドレス<span class="required">*</span>
                    </label>
                    <input
                        type="email"
                        id="registerEmail"
                        class="form-input"
                        placeholder="example@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerPassword">
                        パスワード<span class="required">*</span>
                    </label>
                    <input
                        type="password"
                        id="registerPassword"
                        class="form-input"
                        placeholder="8文字以上のパスワード"
                        minlength="8"
                        required
                    >
                    <div class="form-help">8文字以上で設定してください</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerPasswordConfirm">
                        パスワード（確認）<span class="required">*</span>
                    </label>
                    <input
                        type="password"
                        id="registerPasswordConfirm"
                        class="form-input"
                        placeholder="もう一度パスワードを入力"
                        minlength="8"
                        required
                    >
                </div>

                <button type="submit" class="btn btn-primary btn-full">
                    アカウント登録してエントリー
                </button>
            </form>
        </div>

        <div class="card">
            <p class="text-sm text-center" style="color: var(--text-secondary);">
                QRコードをスキャンした場合、キットIDが自動入力されます<br>
                初めての方は「新規登録」から、アカウントをお持ちの方は「ログイン」からお進みください
            </p>
        </div>
    </div>

    <script>
        // URLパラメータからキットIDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const kitIdFromUrl = urlParams.get('kitId');

        // ページ読み込み時の処理
        window.addEventListener('DOMContentLoaded', () => {
            if (kitIdFromUrl) {
                document.getElementById('kitId').value = kitIdFromUrl;
                document.getElementById('kitIdValue').textContent = kitIdFromUrl;
                document.getElementById('kitIdDisplay').classList.remove('hidden');
                switchTab('register');
            } else {
                switchTab('login');
            }
        });

        // タブ切り替え
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.remove('btn-secondary');
                loginTab.classList.add('btn-primary');
                registerTab.classList.remove('btn-primary');
                registerTab.classList.add('btn-secondary');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.remove('btn-secondary');
                registerTab.classList.add('btn-primary');
                loginTab.classList.remove('btn-primary');
                loginTab.classList.add('btn-secondary');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        // アラート表示関数
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertArea.innerHTML = '';
            }, 5000);
        }

        // ログインフォーム送信
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // ここにGoogle Apps Script Web Appへのリクエストを実装
                const response = await fetch('https://script.google.com/macros/s/AKfycbzNgBKrP724KjBDmNgIXkRDdCLUz_-xByolyaIj2qGQ-mRqv1eLqZLNVX1ijmN2Mots/execL', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'login',
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ログイン成功
                    sessionStorage.setItem('userEmail', email);
                    sessionStorage.setItem('kitId', result.kitId);
                    showAlert('ログインしました', 'success');

                    // マイページへリダイレクト
                    setTimeout(() => {
                        window.location.href = 'mypage.html';
                    }, 1000);
                } else {
                    showAlert(result.message || 'ログインに失敗しました', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('通信エラーが発生しました', 'error');
            }
        });

        // 新規登録フォーム送信
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const kitId = document.getElementById('kitId').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;

            // パスワード確認
            if (password !== passwordConfirm) {
                showAlert('パスワードが一致しません', 'error');
                return;
            }

            try {
                // ここにGoogle Apps Script Web Appへのリクエストを実装
                const response = await fetch('https://script.google.com/macros/s/AKfycbzNgBKrP724KjBDmNgIXkRDdCLUz_-xByolyaIj2qGQ-mRqv1eLqZLNVX1ijmN2Mots/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'register',
                        kitId: kitId,
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // 登録成功
                    sessionStorage.setItem('userEmail', email);
                    sessionStorage.setItem('kitId', kitId);
                    showAlert('登録が完了しました。申込フォームへ進みます', 'success');

                    // 申込フォームへリダイレクト
                    setTimeout(() => {
                        window.location.href = 'form.html';
                    }, 1500);
                } else {
                    showAlert(result.message || '登録に失敗しました', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('通信エラーが発生しました', 'error');
            }
        });
    </script>

    <style>
        .tab-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .tab-buttons .btn {
            flex: 1;
        }
    </style>
</body>
</html>
