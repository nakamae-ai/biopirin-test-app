<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バイオピリン検査 - 申込フォーム</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">バイオピリン検査</div>
            <button class="logout-btn" onclick="logout()">ログアウト</button>
        </div>
    </div>

    <div class="container">
        <!-- キットID表示 -->
        <div class="kit-id-display">
            <div class="kit-id-label">キットID</div>
            <div class="kit-id-value" id="kitIdValue">-</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">申込情報入力</h1>
                <p class="card-description">検査キットをお送りするための情報をご入力ください</p>
            </div>

            <!-- アラート表示エリア -->
            <div id="alertArea"></div>

            <form id="applicationForm">
                <div class="form-group">
                    <label class="form-label" for="fullName">
                        お名前<span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="fullName"
                        class="form-input"
                        placeholder="山田 太郎"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="postalCode">
                        郵便番号<span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="postalCode"
                        class="form-input"
                        placeholder="123-4567"
                        pattern="\d{3}-?\d{4}"
                        required
                    >
                    <div class="form-help">ハイフンあり・なしどちらでも可</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="address">
                        住所<span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        id="address"
                        class="form-input"
                        placeholder="東京都渋谷区〇〇 1-2-3"
                        required
                    >
                    <div class="form-help">都道府県から建物名・部屋番号までご入力ください</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">
                        メールアドレス<span class="required">*</span>
                    </label>
                    <input
                        type="email"
                        id="email"
                        class="form-input"
                        placeholder="example@email.com"
                        required
                        readonly
                    >
                    <div class="form-help">登録時のメールアドレスが自動入力されます</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="phone">
                        電話番号<span class="required">*</span>
                    </label>
                    <input
                        type="tel"
                        id="phone"
                        class="form-input"
                        placeholder="090-1234-5678"
                        pattern="[0-9]{2,4}-?[0-9]{2,4}-?[0-9]{3,4}"
                        required
                    >
                    <div class="form-help">ハイフンあり・なしどちらでも可</div>
                </div>

                <!-- 利用規約 -->
                <div class="card" style="background: var(--bg-color); margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">利用規約</h3>
                    <div style="max-height: 200px; overflow-y: auto; padding: 1rem; background: white; border-radius: 6px; font-size: 0.875rem; line-height: 1.8;">
                        <p style="margin-bottom: 1rem;"><strong>第1条（適用）</strong></p>
                        <p style="margin-bottom: 1rem;">
                            本規約は、当社が提供するバイオピリン検査サービス（以下「本サービス」といいます）の利用に関する条件を定めるものです。
                        </p>

                        <p style="margin-bottom: 1rem;"><strong>第2条（個人情報の取扱い）</strong></p>
                        <p style="margin-bottom: 1rem;">
                            当社は、お客様からご提供いただいた個人情報を、検査キットの発送、検査結果の通知、お問い合わせ対応の目的で利用いたします。
                        </p>

                        <p style="margin-bottom: 1rem;"><strong>第3条（検査について）</strong></p>
                        <p style="margin-bottom: 1rem;">
                            検査結果は医療行為ではなく、参考情報としてご利用ください。気になる症状がある場合は、医療機関にご相談ください。
                        </p>

                        <p style="margin-bottom: 1rem;"><strong>第4条（禁止事項）</strong></p>
                        <p style="margin-bottom: 1rem;">
                            ・虚偽の情報を登録すること<br>
                            ・他人のアカウントを不正に利用すること<br>
                            ・本サービスの運営を妨げる行為
                        </p>

                        <p style="margin-bottom: 1rem;"><strong>第5条（免責事項）</strong></p>
                        <p>
                            当社は、本サービスの内容変更、中断、終了によって生じたいかなる損害についても、一切の責任を負いません。
                        </p>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input
                        type="checkbox"
                        id="agreeTerms"
                        class="checkbox-input"
                        required
                    >
                    <label for="agreeTerms" class="checkbox-label">
                        上記の<a href="#" onclick="return false;">利用規約</a>および<a href="#" onclick="return false;">個人情報保護方針</a>に同意します<span class="required">*</span>
                    </label>
                </div>

                <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
                    申し込む
                </button>
            </form>
        </div>
    </div>

    <script>
        // セッション確認
        const userEmail = sessionStorage.getItem('userEmail');
        const kitId = sessionStorage.getItem('kitId');

        if (!userEmail || !kitId) {
            alert('セッションが切れました。再度ログインしてください。');
            window.location.href = 'index.html';
        }

        // ページ読み込み時の処理
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('kitIdValue').textContent = kitId;
            document.getElementById('email').value = userEmail;
        });

        // ログアウト
        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        // アラート表示関数
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;

            // 自動で消す
            setTimeout(() => {
                alertArea.innerHTML = '';
            }, 5000);
        }

        // フォーム送信
        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '送信中...';

            const formData = {
                action: 'submitApplication',
                kitId: kitId,
                fullName: document.getElementById('fullName').value,
                postalCode: document.getElementById('postalCode').value,
                address: document.getElementById('address').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                agreedToTerms: document.getElementById('agreeTerms').checked
            };

            try {
                // ここにGoogle Apps Script Web Appへのリクエストを実装
                const response = await fetch('https://script.google.com/macros/s/AKfycbzNgBKrP724KjBDmNgIXkRDdCLUz_-xByolyaIj2qGQ-mRqv1eLqZLNVX1ijmN2Mots/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // 完了画面へリダイレクト
                    window.location.href = 'complete.html';
                } else {
                    showAlert(result.message || '申し込みに失敗しました', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '申し込む';
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('通信エラーが発生しました', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '申し込む';
            }
        });
    </script>
</body>
</html>
